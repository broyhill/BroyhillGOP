<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Donor Intelligence - Triple Grading | BroyhillGOP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@3.5.0/dist/tabler-icons.min.css">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root { 
            --text-primary: #1d1d1f; 
            --text-secondary: #86868b; 
            --bg-primary: #ffffff; 
            --bg-secondary: #f5f5f7; 
            --border-light: #e8e8ed; 
            --accent: #0071e3; 
            --success: #34c759; 
            --warning: #ff9500; 
            --danger: #ff3b30; 
            --purple: #af52de; 
            --sidebar-width: 280px; 
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Inter, -apple-system, sans-serif; background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; -webkit-font-smoothing: antialiased; }
        .app { display: flex; min-height: 100vh; }
        
        /* Main Content */
        .main { flex: 1; margin-left: var(--sidebar-width); min-height: 100vh; }
        .topbar { background: var(--bg-primary); border-bottom: 1px solid var(--border-light); padding: 16px 32px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 50; }
        .page-title { font-size: 24px; font-weight: 700; }
        .page-content { padding: 32px; }
        
        /* Triple Grade Toggle */
        .grade-toggle { display: flex; background: var(--bg-secondary); border-radius: 12px; padding: 4px; gap: 4px; }
        .grade-toggle-btn { padding: 10px 20px; border-radius: 8px; border: none; background: transparent; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .grade-toggle-btn.active { background: var(--bg-primary); box-shadow: 0 2px 8px rgba(0,0,0,0.1); color: var(--accent); }
        .grade-toggle-btn:hover:not(.active) { background: rgba(0,0,0,0.05); }
        
        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-primary); border: 1px solid var(--border-light); border-radius: 16px; padding: 24px; }
        .stat-value { font-size: 32px; font-weight: 800; margin-bottom: 4px; }
        .stat-label { font-size: 13px; color: var(--text-secondary); }
        
        /* Selectors */
        .context-selector { display: none; margin-left: 20px; }
        .context-selector.visible { display: flex; align-items: center; gap: 10px; }
        .context-selector select { padding: 8px 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; background: white; min-width: 200px; }
        
        /* Grade Columns */
        .grade-comparison { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 32px; }
        .grade-column { background: var(--bg-primary); border: 1px solid var(--border-light); border-radius: 16px; padding: 24px; transition: all 0.3s; }
        .grade-column.active { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1); }
        .grade-column-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .grade-distribution { display: flex; flex-direction: column; gap: 8px; }
        .grade-bar { display: flex; align-items: center; gap: 10px; }
        .grade-bar-label { width: 40px; font-weight: 600; font-size: 12px; }
        .grade-bar-fill { height: 24px; border-radius: 6px; transition: width 0.5s ease; }
        .grade-bar-count { font-size: 12px; color: var(--text-secondary); margin-left: 8px; }
        
        /* Donor Table */
        .donor-table-container { background: var(--bg-primary); border: 1px solid var(--border-light); border-radius: 16px; overflow: hidden; }
        .table-header { padding: 20px 24px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; }
        .table-title { font-size: 18px; font-weight: 600; }
        .donor-table { width: 100%; border-collapse: collapse; }
        .donor-table th { text-align: left; padding: 14px 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); background: var(--bg-secondary); }
        .donor-table td { padding: 16px 20px; border-bottom: 1px solid var(--border-light); }
        .donor-table tr:hover { background: var(--bg-secondary); }
        
        .grade-badge { display: inline-flex; align-items: center; justify-content: center; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; min-width: 40px; }
        .grade-badge.highlight { box-shadow: 0 0 0 2px var(--accent); }
        .grade-a { background: rgba(52, 199, 89, 0.15); color: #1d8348; }
        .grade-b { background: rgba(0, 122, 255, 0.15); color: #0056b3; }
        .grade-c { background: rgba(255, 149, 0, 0.15); color: #cc7700; }
        .grade-d { background: rgba(255, 59, 48, 0.15); color: #cc0000; }
        .grade-u { background: rgba(134, 134, 139, 0.15); color: #555; }
        
        .donor-name { font-weight: 600; }
        .donor-location { font-size: 12px; color: var(--text-secondary); }
        
        /* Filter Buttons */
        .filter-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
        .filter-btn { padding: 8px 16px; border: 1px solid var(--border-light); border-radius: 20px; background: white; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .filter-btn:hover { border-color: var(--accent); }
        .filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        /* Loading */
        .loading { text-align: center; padding: 60px; color: var(--text-secondary); }
        .loading i { font-size: 40px; animation: spin 1s linear infinite; display: block; margin-bottom: 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 60px; color: var(--text-secondary); }
        .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    </style>
</head>
<body>

<!-- Sidebar Placeholder - Will be injected by navigation.js -->
<div id="sidebar-placeholder"></div>

<!-- Main Content -->
<main class="main">
    <div class="topbar">
        <div class="page-title">Donor Intelligence</div>
        <div style="display: flex; align-items: center; gap: 16px;">
            <div class="grade-toggle">
                <button class="grade-toggle-btn active" id="btn-state" onclick="setGradeView('state')">
                    <i class="ti ti-map"></i> Statewide
                </button>
                <button class="grade-toggle-btn" id="btn-district" onclick="setGradeView('district')">
                    <i class="ti ti-route"></i> By District
                </button>
                <button class="grade-toggle-btn" id="btn-county" onclick="setGradeView('county')">
                    <i class="ti ti-building-community"></i> By County
                </button>
            </div>
            
            <div class="context-selector" id="district-selector">
                <select id="district-select" onchange="loadDistrictData()">
                    <option value="">Select District...</option>
                </select>
            </div>
            
            <div class="context-selector" id="county-selector">
                <select id="county-select" onchange="loadCountyData()">
                    <option value="">Select County...</option>
                </select>
            </div>
        </div>
    </div>
    
    <div class="page-content">
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-donors">-</div>
                <div class="stat-label">Total Donors</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="context-count">-</div>
                <div class="stat-label" id="context-label">In Current View</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="a-tier-count">-</div>
                <div class="stat-label">A-Tier Donors</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-raised">-</div>
                <div class="stat-label">Total Raised</div>
            </div>
        </div>
        
        <!-- Grade Distribution -->
        <div class="grade-comparison">
            <div class="grade-column active" id="col-state">
                <div class="grade-column-title"><i class="ti ti-map"></i> State Grade</div>
                <div class="grade-distribution" id="dist-state">
                    <div class="loading"><i class="ti ti-loader-2"></i></div>
                </div>
            </div>
            <div class="grade-column" id="col-district">
                <div class="grade-column-title"><i class="ti ti-route"></i> District Grade</div>
                <div class="grade-distribution" id="dist-district">
                    <div class="loading"><i class="ti ti-loader-2"></i></div>
                </div>
            </div>
            <div class="grade-column" id="col-county">
                <div class="grade-column-title"><i class="ti ti-building-community"></i> County Grade</div>
                <div class="grade-distribution" id="dist-county">
                    <div class="loading"><i class="ti ti-loader-2"></i></div>
                </div>
            </div>
        </div>
        
        <!-- Filter Bar -->
        <div class="filter-bar">
            <button class="filter-btn active" data-grade="all">All Grades</button>
            <button class="filter-btn" data-grade="A++">A++</button>
            <button class="filter-btn" data-grade="A+">A+</button>
            <button class="filter-btn" data-grade="A">A</button>
            <button class="filter-btn" data-grade="B+">B+</button>
            <button class="filter-btn" data-grade="B">B</button>
            <button class="filter-btn" data-grade="C">C</button>
            <button class="filter-btn" data-grade="D">D</button>
            <button class="filter-btn" data-grade="U">U</button>
        </div>
        
        <!-- Donor Table -->
        <div class="donor-table-container">
            <div class="table-header">
                <div class="table-title" id="table-title">Top Donors - Statewide View</div>
            </div>
            <table class="donor-table">
                <thead>
                    <tr>
                        <th>Donor</th>
                        <th>Total Given</th>
                        <th>State Grade</th>
                        <th>District Grade</th>
                        <th>County Grade</th>
                        <th>Last Donation</th>
                    </tr>
                </thead>
                <tbody id="donor-table-body">
                    <tr><td colspan="6"><div class="loading"><i class="ti ti-loader-2"></i> Loading donors...</div></td></tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<!-- Shared Navigation -->
<script src="scripts/navigation.js"></script>

<script>
// ============================================================================
// SUPABASE CONNECTION
// ============================================================================
const SUPABASE_URL = 'https://isbgjpnbocdkeslofota.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlzYmdqcG5ib2Nka2VzbG9mb3RhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MDc3MDcsImV4cCI6MjA4MDI4MzcwN30.pSF0-C-QOklmDWtbexUvnFphuz_bFTdF4INaBMSW1SM';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentView = 'state';
let currentGradeFilter = 'all';
let allDonors = [];

// ============================================================================
// INITIALIZE
// ============================================================================
document.addEventListener('DOMContentLoaded', async () => {
    // Inject navigation
    if (window.BroyhillGOP) {
        window.BroyhillGOP.injectNavigation('donor-intelligence');
    }
    
    // Load all data
    await Promise.all([
        loadDonors(),
        loadDistricts(),
        loadCounties(),
        loadGradeDistributions()
    ]);
    
    // Setup filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentGradeFilter = this.dataset.grade;
            renderDonorTable();
        });
    });
});

// ============================================================================
// LOAD DATA
// ============================================================================
async function loadDonors() {
    try {
        const { data, error } = await supabase
            .from('persons')
            .select('*')
            .eq('is_donor', true)
            .order('donation_total', { ascending: false })
            .limit(200);
        
        if (error) throw error;
        
        allDonors = data || [];
        
        // Update stats
        document.getElementById('total-donors').textContent = allDonors.length.toLocaleString();
        document.getElementById('context-count').textContent = allDonors.length.toLocaleString();
        
        const aTier = allDonors.filter(d => d.donor_grade_state?.startsWith('A')).length;
        document.getElementById('a-tier-count').textContent = aTier.toLocaleString();
        
        const totalRaised = allDonors.reduce((sum, d) => sum + (d.donation_total || 0), 0);
        document.getElementById('total-raised').textContent = '$' + totalRaised.toLocaleString();
        
        renderDonorTable();
        
    } catch (error) {
        console.error('Error loading donors:', error);
        document.getElementById('donor-table-body').innerHTML = `
            <tr><td colspan="6"><div class="empty-state">
                <i class="ti ti-database-off"></i>
                <p>Could not load donors. Check database connection.</p>
            </div></td></tr>`;
    }
}

async function loadDistricts() {
    try {
        const { data, error } = await supabase
            .from('nc_districts')
            .select('*')
            .order('district_id');
        
        if (error) throw error;
        
        const select = document.getElementById('district-select');
        (data || []).forEach(d => {
            const option = document.createElement('option');
            option.value = d.district_id;
            option.textContent = d.district_name || d.district_id;
            select.appendChild(option);
        });
        
    } catch (error) {
        console.log('Districts not loaded:', error.message);
    }
}

async function loadCounties() {
    // NC Counties
    const counties = [
        'Alamance', 'Alexander', 'Alleghany', 'Anson', 'Ashe', 'Avery', 'Beaufort', 'Bertie', 'Bladen', 'Brunswick',
        'Buncombe', 'Burke', 'Cabarrus', 'Caldwell', 'Camden', 'Carteret', 'Caswell', 'Catawba', 'Chatham', 'Cherokee',
        'Chowan', 'Clay', 'Cleveland', 'Columbus', 'Craven', 'Cumberland', 'Currituck', 'Dare', 'Davidson', 'Davie',
        'Duplin', 'Durham', 'Edgecombe', 'Forsyth', 'Franklin', 'Gaston', 'Gates', 'Graham', 'Granville', 'Greene',
        'Guilford', 'Halifax', 'Harnett', 'Haywood', 'Henderson', 'Hertford', 'Hoke', 'Hyde', 'Iredell', 'Jackson',
        'Johnston', 'Jones', 'Lee', 'Lenoir', 'Lincoln', 'Macon', 'Madison', 'Martin', 'McDowell', 'Mecklenburg',
        'Mitchell', 'Montgomery', 'Moore', 'Nash', 'New Hanover', 'Northampton', 'Onslow', 'Orange', 'Pamlico', 'Pasquotank',
        'Pender', 'Perquimans', 'Person', 'Pitt', 'Polk', 'Randolph', 'Richmond', 'Robeson', 'Rockingham', 'Rowan',
        'Rutherford', 'Sampson', 'Scotland', 'Stanly', 'Stokes', 'Surry', 'Swain', 'Transylvania', 'Tyrrell', 'Union',
        'Vance', 'Wake', 'Warren', 'Washington', 'Watauga', 'Wayne', 'Wilkes', 'Wilson', 'Yadkin', 'Yancey'
    ];
    
    const select = document.getElementById('county-select');
    counties.forEach(c => {
        const option = document.createElement('option');
        option.value = c;
        option.textContent = c + ' County';
        select.appendChild(option);
    });
}

async function loadGradeDistributions() {
    // Calculate from loaded donors
    const grades = ['A++', 'A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D+', 'D', 'D-', 'U'];
    const maxCount = Math.max(...grades.map(g => allDonors.filter(d => d.donor_grade_state === g).length)) || 1;
    
    ['state', 'district', 'county'].forEach(context => {
        const container = document.getElementById(`dist-${context}`);
        const gradeField = `donor_grade_${context}`;
        
        let html = '';
        grades.forEach(grade => {
            const count = allDonors.filter(d => d[gradeField] === grade).length;
            const width = (count / maxCount) * 100;
            const colorClass = grade.startsWith('A') ? '#34c759' : 
                              grade.startsWith('B') ? '#007aff' : 
                              grade.startsWith('C') ? '#ff9500' : 
                              grade.startsWith('D') ? '#ff3b30' : '#86868b';
            
            html += `
                <div class="grade-bar">
                    <span class="grade-bar-label">${grade}</span>
                    <div class="grade-bar-fill" style="width: ${width}%; background: ${colorClass};"></div>
                    <span class="grade-bar-count">${count.toLocaleString()}</span>
                </div>`;
        });
        
        container.innerHTML = html || '<div class="empty-state">No data</div>';
    });
}

// ============================================================================
// RENDER TABLE
// ============================================================================
function renderDonorTable() {
    const tbody = document.getElementById('donor-table-body');
    
    let filtered = allDonors;
    if (currentGradeFilter !== 'all') {
        const gradeField = `donor_grade_${currentView}`;
        filtered = allDonors.filter(d => d[gradeField] === currentGradeFilter);
    }
    
    if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state">
            <i class="ti ti-users-off"></i>
            <p>No donors found with selected filter.</p>
        </div></td></tr>`;
        return;
    }
    
    tbody.innerHTML = filtered.slice(0, 100).map(d => {
        const stateGrade = d.donor_grade_state || 'U';
        const districtGrade = d.donor_grade_district || d.donor_grade_state || 'U';
        const countyGrade = d.donor_grade_county || d.donor_grade_state || 'U';
        
        return `
            <tr>
                <td>
                    <div class="donor-name">${d.full_name || d.first_name + ' ' + d.last_name || 'Unknown'}</div>
                    <div class="donor-location">${d.city || ''}, ${d.county || 'NC'}</div>
                </td>
                <td>$${(d.donation_total || 0).toLocaleString()}</td>
                <td><span class="grade-badge ${getGradeClass(stateGrade)} ${currentView === 'state' ? 'highlight' : ''}">${stateGrade}</span></td>
                <td><span class="grade-badge ${getGradeClass(districtGrade)} ${currentView === 'district' ? 'highlight' : ''}">${districtGrade}</span></td>
                <td><span class="grade-badge ${getGradeClass(countyGrade)} ${currentView === 'county' ? 'highlight' : ''}">${countyGrade}</span></td>
                <td>${d.last_donation_date ? new Date(d.last_donation_date).toLocaleDateString() : '-'}</td>
            </tr>`;
    }).join('');
}

function getGradeClass(grade) {
    if (!grade) return 'grade-u';
    if (grade.startsWith('A')) return 'grade-a';
    if (grade.startsWith('B')) return 'grade-b';
    if (grade.startsWith('C')) return 'grade-c';
    if (grade.startsWith('D')) return 'grade-d';
    return 'grade-u';
}

// ============================================================================
// VIEW TOGGLE
// ============================================================================
function setGradeView(view) {
    currentView = view;
    
    // Update buttons
    document.getElementById('btn-state').classList.toggle('active', view === 'state');
    document.getElementById('btn-district').classList.toggle('active', view === 'district');
    document.getElementById('btn-county').classList.toggle('active', view === 'county');
    
    // Update column highlights
    document.getElementById('col-state').classList.toggle('active', view === 'state');
    document.getElementById('col-district').classList.toggle('active', view === 'district');
    document.getElementById('col-county').classList.toggle('active', view === 'county');
    
    // Show/hide selectors
    document.getElementById('district-selector').classList.toggle('visible', view === 'district');
    document.getElementById('county-selector').classList.toggle('visible', view === 'county');
    
    // Update title
    const titles = { state: 'Statewide View', district: 'District View', county: 'County View' };
    document.getElementById('table-title').textContent = 'Top Donors - ' + titles[view];
    
    // Re-render table with new highlights
    renderDonorTable();
}

async function loadDistrictData() {
    const district = document.getElementById('district-select').value;
    if (!district) return;
    
    document.getElementById('table-title').textContent = `Top Donors - ${district}`;
    
    try {
        const { data } = await supabase
            .from('persons')
            .select('*')
            .eq('is_donor', true)
            .eq('district_state_house', district)
            .order('donation_total', { ascending: false })
            .limit(100);
        
        allDonors = data || [];
        document.getElementById('context-count').textContent = allDonors.length.toLocaleString();
        renderDonorTable();
        loadGradeDistributions();
        
    } catch (error) {
        console.error('Error:', error);
    }
}

async function loadCountyData() {
    const county = document.getElementById('county-select').value;
    if (!county) return;
    
    document.getElementById('table-title').textContent = `Top Donors - ${county} County`;
    
    try {
        const { data } = await supabase
            .from('persons')
            .select('*')
            .eq('is_donor', true)
            .eq('county', county)
            .order('donation_total', { ascending: false })
            .limit(100);
        
        allDonors = data || [];
        document.getElementById('context-count').textContent = allDonors.length.toLocaleString();
        renderDonorTable();
        loadGradeDistributions();
        
    } catch (error) {
        console.error('Error:', error);
    }
}
</script>

</body>
</html>
